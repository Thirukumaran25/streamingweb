{% extends 'base.html' %}

{% block title %}Home | Streaming Star{% endblock %}

{% block content %}

{% if featured %}

<section class="relative min-h-screen w-full overflow-hidden">

    <div class="absolute inset-0">
        <img src="{{ featured.image.url }}" class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-r from-black via-black/70 to-transparent"></div>
    </div>

    <div class="relative z-10 flex flex-col justify-center h-full px-6 md:px-16 max-w-3xl text-white">

        <h1 class="text-4xl md:text-6xl font-extrabold mb-4">
            {{ featured.title }}
        </h1>

        <div class="flex gap-4 text-gray-300 mb-4 text-sm">
            <span>{{ featured.year }}</span>
            <span>{{ featured.duration }}</span>
            <span class="border px-2 py-1 text-xs rounded">{{ featured.category }}</span>
        </div>

        <p class="max-w-xl mb-6 line-clamp-3">{{ featured.description }}</p>

        <div class="flex gap-4">

            <a href="{% url 'play_movie' featured.id %}"
               class="bg-white text-black px-6 py-3 rounded font-bold flex items-center gap-2">
                <i class="bx bx-play"></i> Play
            </a>

            {% if user.is_authenticated %}
            <button 
                onclick="toggleMyList({{ featured.id }}, this)" 
                class="px-6 py-3 rounded font-bold flex items-center gap-2 transition-colors duration-300
                {% if featured.id in my_list_ids %} bg-green-600 {% else %} bg-gray-600 {% endif %} text-white">
                
                {% if featured.id in my_list_ids %}
                    <i class="bx bx-check"></i> <span>Added</span>
                {% else %}
                    <i class="bx bx-plus"></i> <span>My List</span>
                {% endif %}
            </button>

            {% endif %}

        </div>
    </div>
</section>
{% endif %}


<div class="bg-black px-6 md:px-20 -mt-32 pb-20 space-y-16 relative z-20">

<section class="relative group">
    <h2 class="text-white text-lg font-bold mb-4">Movies</h2>
    
    <div class="relative">
        <button onclick="scrollContainer('movies-scroll', -400)" 
                class="scroll-btn left-0 z-30 opacity-100">
            <i class="bx bx-chevron-left text-2xl"></i>
        </button>
        
        <div id="movies-scroll" class="scroll-row">
            {% for movie in movies %}
            <a href="{% url 'movie_detail' movie.id %}" class="movie-card flex-shrink-0">
                <div class="poster-wrapper">
                    <img src="{{ movie.poster.url }}" alt="{{ movie.title }}">
                </div>
                <h3>{{ movie.title }}</h3>
                <p>{{ movie.year }} · {{ movie.duration }}</p>
            </a>
            {% endfor %}
        </div>
        
        <button onclick="scrollContainer('movies-scroll', 400)" 
                class="scroll-btn right-0 z-30 opacity-100">
            <i class="bx bx-chevron-right text-2xl"></i>
        </button>
    </div>
</section>


<section class="relative group">
    <h2 class="text-white text-lg font-bold mb-4">TV Shows</h2>
    
    <div class="relative">
        <button onclick="scrollContainer('tv-scroll', -400)" 
                class="scroll-btn left-0 z-30 opacity-100">
            <i class="bx bx-chevron-left text-2xl"></i>
        </button>
        
        <div id="tv-scroll" class="scroll-row">
            {% for show in tv_shows %}
            <a href="{% url 'movie_detail' show.id %}" class="movie-card flex-shrink-0">
                <div class="poster-wrapper">
                    <img src="{{ show.poster.url }}" alt="{{ show.title }}">
                </div>
                <h3>{{ show.title }}</h3>
                <p>{{ show.year }} · {{ show.duration }}</p>
            </a>
            {% endfor %}
        </div>
        
        <button onclick="scrollContainer('tv-scroll', 400)" 
                class="scroll-btn right-0 z-30 opacity-100">
            <i class="bx bx-chevron-right text-2xl"></i>
        </button>
    </div>
</section>


<section class="relative group">
    <div class="flex justify-between mb-4">
        <h2 class="text-white text-lg font-bold">My List</h2>
        <a href="{% url 'my_list' %}" class="text-yellow-400 text-sm hover:text-yellow-300 transition">See All ></a>
    </div>
    
    {% if my_list %}
    <div class="relative">
        <button onclick="scrollContainer('mylist-scroll', -400)" 
                class="scroll-btn left-0 z-30 opacity-100">
            <i class="bx bx-chevron-left text-2xl"></i>
        </button>
        
        <div id="mylist-scroll" class="scroll-row">
            {% for item in my_list %}
            <a href="{% url 'movie_detail' item.movie.id %}" class="movie-card flex-shrink-0">
                <div class="poster-wrapper">
                    <img src="{{ item.movie.poster.url }}" alt="{{ item.movie.title }}">
                </div>
                <h3>{{ item.movie.title }}</h3>
                <p>{{ item.movie.year }} · {{ item.movie.duration }}</p>
            </a>
            {% endfor %}
        </div>
        
        <button onclick="scrollContainer('mylist-scroll', 400)" 
                class="scroll-btn right-0 z-30 opacity-100">
            <i class="bx bx-chevron-right text-2xl"></i>
        </button>
    </div>
    {% else %}
    <p class="text-gray-400">Your list is empty.</p>
    {% endif %}
</section>


<section class="relative group">
    <h2 class="text-white text-lg font-bold mb-4">Genres</h2>
    
    <div class="relative">
        <button onclick="scrollContainer('genres-scroll', -400)" 
                class="scroll-btn left-0 z-30 opacity-100">
            <i class="bx bx-chevron-left text-2xl"></i>
        </button>
        
        <div id="genres-scroll" class="scroll-row">
            {% for genre in genres %}
            <a href="{% url 'category_list' 'movies' %}?genre={{ genre.name }}" class="genre-card flex-shrink-0">
                <img src="{{ genre.image.url }}" alt="{{ genre.name }}">
                <div class="overlay">
                    <i class="bx {{ genre.icon_class }} text-3xl text-yellow-400 mb-2"></i>
                    <h3 class="text-sm md:text-base font-extrabold uppercase tracking-wider">
                        {{ genre.name }}
                    </h3>
                </div>
            </a>
            {% endfor %}
        </div>
        
        <button onclick="scrollContainer('genres-scroll', 400)" 
               class="scroll-btn right-0 z-30 opacity-100">
            <i class="bx bx-chevron-right text-2xl"></i>
        </button>
    </div>
</section>

</div>


<script>
function scrollContainer(containerId, scrollAmount) {
    const container = document.getElementById(containerId);
    if (container) {
        container.scrollBy({
            left: scrollAmount,
            behavior: 'smooth'
        });
    }
}

function toggleMyList(id, button) {
    // Get the CSRF token from cookies
    const csrftoken = document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];

    fetch(`/toggle_my_list/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        // Toggle UI based on response
        if (data.added) {
            // STATE: MOVIE ADDED
            button.classList.remove("bg-gray-600");
            button.classList.add("bg-green-600");
            button.innerHTML = '<i class="bx bx-check"></i> <span>Added</span>';
        } else {
            // STATE: MOVIE REMOVED
            button.classList.remove("bg-green-600");
            button.classList.add("bg-gray-600");
            button.innerHTML = '<i class="bx bx-plus"></i> <span>My List</span>';
        }
    })
    .catch(err => console.error("Error toggling list:", err));
}
</script>

<style>
.scroll-row {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 10px 0;
    -ms-overflow-style: none; 
    scrollbar-width: none;
}

.scroll-row::-webkit-scrollbar {
    display: none;
}

.movie-card {
    width: 180px;
    text-align: center;
    color: white;
    text-decoration: none;
    flex-shrink: 0;
}

.poster-wrapper {
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 2/3;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.movie-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.movie-card:hover img {
    transform: scale(1.05);
}

/* Scroll button styles - Forced visibility */
.scroll-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.7) !important; /* Semi-transparent background for contrast */
    color: white;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
    opacity: 1 !important; /* Always visible */
}

.scroll-btn:hover {
    background: #FFB800 !important;
    color: black;
    border-color: #FFB800;
}

.scroll-btn i {
    font-size: 24px;
}

.genre-card {
    width: 170px;
    height: 120px;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.genre-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.6;
}

.genre-card .overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
}
</style>

{% endblock %}